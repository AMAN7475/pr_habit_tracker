{% extends "base.html" %}

{% block title %}My Profile - Track It{% endblock %}
{% block heading %}My Profile{% endblock %}

{% block content %}
<div class="profile-container">
  <div class="profile-card">
    <h2>{{ user.username }}</h2>

    <form id="profileForm" method="POST" action="{{ url_for('update_profile') }}" onsubmit="formatNamesBeforeSubmit()">

      <!-- First & Last Name in one row -->
      <div class="form-row">
        <div class="form-group half">
          <label>First Name</label>
          <input type="text" name="first_name" id="first_name" value="{{ user.first_name }}" required  oninput="capitalizeFirstLetter(this)" minlength="3" maxlength="20">
          {% if errors.get('first_name') %}
            <small style="color:#f5f545; font-size:0.8rem;">{{ errors['first_name'] }}</small>
          {% endif %}
        </div>

        <div class="form-group half">
          <label>Last Name</label>
          <input type="text" name="last_name" id="last_name" value="{{ user.last_name }}" required oninput="capitalizeFirstLetter(this)" minlength="3" maxlength="20">
          {% if errors.get('first_name') %}
            <small style="color:#f5f545; font-size:0.8rem;">{{ errors['last_name'] }}</small>
          {% endif %}
        </div>
      </div>

      <!-- Contact No -->
      <div class="form-group">
        <label>Mobile No</label>
        <input type="text" name="mobile" id="mobile" value="{{ user.mobile }}" maxlength="10" required>
        <small id="mobile_error" style="color:#f5f545; font-size:0.8rem; display:block;">
          {% if errors.get('mobile') %} {{ errors['mobile'] }} {% endif %}
        </small>
      </div>

      <!-- Date of Birth -->
      <div class="form-group">
        <label>Date of Birth</label>
        <input type="date" name="dob" id="dob" value="{{ user.dob }}" max="{{ current_date }}" required >
        <small id="dob_error" style="color:#f5f545; font-size:0.8rem; display:block;">
          {% if errors.get('dob') %} {{ errors['dob'] }} {% endif %}
        </small>
      </div>

      <!-- Email -->
      <div class="form-group">
        <label>Email</label>
        <input type="email" name="email" value="{{ user.email }}" required>
      </div>

      <button type="submit" class="save-btn">Save Changes</button>
    </form>
  </div>
</div>

<style>
  
  .profile-container {
    display: flex;
    justify-content: center;
    margin-top: 0px;
    padding: 0 15px;
  }

 
  .profile-card {
    background: rgba(255, 255, 255, 0.05);
    padding: 15px 25px 25px 25px;
    border-radius: 15px;
    box-shadow: 0px 5px 12px rgba(0, 0, 0, 0.4);
    text-align: center;
    transition: all 0.3s ease;
    width: 100%;
    max-width: 450px; 
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin-top: -50px; 
    transform: scale(0.92); 
    transform-origin: justify-content; 
  }

  .profile-card h2 {
    color: #00ff99;
    margin-top: 6px;
    margin-bottom: 20px;
    font-size: 1.8rem;
  }

 
  .form-row {
    display: flex;
    gap: 12px;
    margin-bottom: 0px;
    justify-content: space-between;
    flex-wrap: wrap;
  }

  .form-group {
    margin-bottom: 15px;
    width: 100%;
    display: flex;
    flex-direction: column;
    text-align: left;
  }

  .form-group.half {
    flex: 0 0 calc(50% - 12px);
  }

  .form-group label {
    font-size: 15px;
    margin-bottom: 6px;
    margin-left: 3px;
    color: #ccc;
  }

  .form-group input {
    width: 100%;
    height: 50px;
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid rgba(0, 0, 0, 0.40);
    box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.20);
    outline: none;
    font-size: 15px;
    background: rgba(255, 255, 255, 0.08);
    color: #fff;
    text-align: left;
    box-sizing: border-box;
    transition: all 0.2s ease;
  }

  .form-group input:focus {
    border-color: #00cc77;
    background: rgba(255, 255, 255, 0.12);
  }

  .save-btn {
    margin-top: 10px;
    padding: 10px 22px;
    border: none;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.05);
    color: #fff;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 15px;
    box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.40);
  }

  .save-btn:hover {
    background: #00ff99;
    color: #000;
    transform: translateY(-3px);
  }
</style>

  <script>
    //---------------------------
    // Capitalize as user types
    //---------------------------
    function capitalizeFirstLetter(input) {
      if (input.value.length > 0) {
        input.value = input.value.charAt(0).toUpperCase() + input.value.slice(1).toLowerCase();
      }
    }

    // Ensure names are formatted before submission
    function formatNamesBeforeSubmit() {
      const firstName = document.getElementById('first_name');
      const lastName = document.getElementById('last_name');
      capitalizeFirstLetter(firstName);
      capitalizeFirstLetter(lastName);
    }

    //----------------------------
    // Name Validation
    //----------------------------
    function capitalizeFirstLetter(input) {
      if (input.value.length > 0) {
        input.value = input.value.charAt(0).toUpperCase() + input.value.slice(1).toLowerCase();
      }
    }

    // Validate first and last names before submission
    function validateProfileForm() {
      const firstName = document.getElementById("first_name").value.trim();
      const lastName = document.getElementById("last_name").value.trim();

      const namePattern = /^[A-Z][a-z]{2,19}$/; // 1 uppercase + 2–19 lowercase only

      if (!namePattern.test(firstName) || !namePattern.test(lastName)) {
        alert("First Name and Last Name must start with a capital letter, followed by lowercase letters only (3–20 total).");
        return false;
      }

      return true;
    }

    // -------------------------
    // Mobile No Validation
    // -------------------------
    const mobileInput = document.getElementById("mobile");
    const mobileError = document.getElementById("mobile_error");

    function validateMobile(value) {
      if (!/^[6-9][0-9]{9}$/.test(value)) {
        mobileError.innerText = "Invalid mobile no. Must be 10 digits and start with 6-9";
        mobileError.style.display = "block";
        return false;
      } else {
        mobileError.innerText = "";
        mobileError.style.display = "none";
        return true;
      }
    }

    // Restrict typing to digits only and max 10 characters
    mobileInput.addEventListener("input", function() {
      this.value = this.value.replace(/[^0-9]/g, "").slice(0, 10);
      validateMobile(this.value);
    });

    // Validate before form submission
    document.getElementById("profileForm").addEventListener("submit", function(e) {
      if (!validateMobile(mobileInput.value)) {
        e.preventDefault(); // stop submission if invalid
      }
    });

    // -------------------------
    // DOB Validation
    // -------------------------
    
    const dobInput = document.getElementById("dob");
    const dobError = document.getElementById("dob_error");

    function validateDOB(value) {
      const today = new Date();
      const inputDate = new Date(value);
      if (inputDate > today) {
        // Format today in mm/dd/yyyy
        const dd = String(today.getDate()).padStart(2, '0');
        const mm = String(today.getMonth() + 1).padStart(2, '0'); // Month is 0-based
        const yyyy = today.getFullYear();
        dobError.innerText = `DOB cannot be in the future (max ${mm}/${dd}/${yyyy})`;
        dobError.style.display = "block";
        return false;
      } else {
        dobError.innerText = "";
        dobError.style.display = "none";
        return true;
      }
    }

    // Validate on change (calendar or manual input)
    dobInput.addEventListener("change", function() {
      validateDOB(this.value);
    });

    // Validate before form submission
    document.getElementById("profileForm").addEventListener("submit", function(e) {
      if (!validateDOB(dobInput.value)) {
        e.preventDefault(); // stop submission if invalid
      }
    });
  </script>
{% endblock %}
